<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test di Fisica - Prova Alpha 2</title>
    <!-- Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    
    <style>
        :root {
            /* Palette from ParabolaWhat */
            --bg-color: #faf5ff;       /* Purple 50 */
            --card-bg: #ffffff;
            --text-primary: #4c1d95;   /* Purple 900 */
            --text-secondary: #7e22ce; /* Purple 700 */
            --accent-color: #7c3aed;   /* Violet 600 */
            --accent-hover: #6d28d9;   /* Violet 700 */
            --accent-light: #ddd6fe;   /* Violet 200 */
            --accent-subtle: #f5f3ff;  /* Violet 50 */
            --border-color: #e9d5ff;   /* Purple 200 */
            --shadow-sm: 0 1px 2px 0 rgba(124, 58, 237, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(124, 58, 237, 0.1), 0 2px 4px -1px rgba(124, 58, 237, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(124, 58, 237, 0.15), 0 4px 6px -2px rgba(124, 58, 237, 0.1);
            
            --font-family: 'Space Mono', monospace;
            --correct-color: #10b981; /* Emerald 500 */
            --wrong-color: #ef4444;   /* Red 500 */
        }

        * {
            box-sizing: border-box;
            font-family: var(--font-family);
        }

        body {
            margin: 0;
            padding: 1rem;
            background-color: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            justify-content: center;
        }

        .app-container {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 1rem;
        }

        h1 {
            font-size: 2rem;
            font-weight: 800;
            margin: 0;
            background: linear-gradient(135deg, var(--text-secondary), var(--accent-color));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        /* Views */
        .view {
            display: none;
            flex-direction: column;
            gap: 1.5rem;
            animation: fadeIn 0.3s ease-out;
        }
        .view.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Card */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Buttons */
        .btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 99px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(124, 58, 237, 0.2);
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
        }

        .btn.secondary {
            background: var(--accent-subtle);
            color: var(--accent-color);
            border: 1px solid var(--border-color);
            box-shadow: none;
        }
        .btn.secondary:hover {
            border-color: var(--accent-color);
        }

        .btn.outline {
            background: transparent;
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
            box-shadow: none;
        }
        .btn.outline:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Navigation Grid */
        .nav-grid {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
        }

        .question-dots {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
        }
        .dot.active {
            background: var(--accent-color);
            transform: scale(1.2);
        }
        .dot.answered {
            background: var(--accent-light);
            box-shadow: 0 0 0 2px var(--accent-color);
        }
        .dot.correct {
            background: var(--correct-color);
        }
        .dot.wrong {
            background: var(--wrong-color);
        }


        /* Question Content */
        .question-text {
            font-size: 1.25rem;
            font-weight: 600;
            line-height: 1.4;
        }

        .options-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .option-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .option-item:hover {
            background: var(--accent-subtle);
            border-color: var(--accent-color);
        }

        .option-item.selected {
            background: var(--accent-subtle);
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px var(--accent-color);
        }
        
        .option-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
            flex-shrink: 0;
        }

        .option-item.selected .option-circle {
            background: var(--accent-color);
            border-color: var(--accent-color);
            color: white;
        }

        /* Input for Fill Blank */
        .fill-input {
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            border: 2px solid var(--border-color);
            border-radius: 1rem;
            outline: none;
            transition: all 0.2s;
            font-family: var(--font-family);
        }
        .fill-input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px var(--accent-light);
        }

        /* Review Mode Styles */
        .review-mode .option-item {
            pointer-events: none; /* Disable interaction */
        }
        
        .review-mode .option-item.correct-answer {
            border-color: var(--correct-color);
            background-color: rgba(16, 185, 129, 0.1);
        }
        .review-mode .option-item.correct-answer::after {
            content: '✓';
            color: var(--correct-color);
            font-weight: bold;
            position: absolute;
            right: 1rem;
            font-size: 1.5rem;
        }

        .review-mode .option-item.user-wrong {
            border-color: var(--wrong-color);
            background-color: rgba(239, 68, 68, 0.1);
        }
        .review-mode .option-item.user-correct {
            border-color: var(--correct-color);
            background-color: rgba(16, 185, 129, 0.1);
            /* Already handled by correct-answer logic usually, but specific user feedback */
        }

        .review-mode .option-item.correct-answer .option-circle {
            background: var(--correct-color);
            border-color: var(--correct-color);
            color: white;
        }
        .review-mode .option-item.user-wrong .option-circle {
            background: var(--wrong-color);
            border-color: var(--wrong-color);
            color: white;
            content: '✕';
        }

        .feedback-banner {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            font-weight: 700;
            text-align: center;
            display: none;
        }
        .review-mode .feedback-banner {
            display: block;
        }
        .feedback-banner.correct {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--correct-color);
        }
        .feedback-banner.wrong {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--wrong-color);
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }
        .progress-bar {
            height: 100%;
            background: var(--accent-color);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* Highlight specific for text */
        .highlight-yellow {
            background-color: #fde047; /* Yellow 300 */
            padding: 0 0.2rem;
            border-radius: 0.2rem;
            color: black;
        }

        /* Results Page */
        .results-summary {
            text-align: center;
        }
        .score-big {
            font-size: 4rem;
            font-weight: 800;
            color: var(--accent-color);
            margin: 1rem 0;
        }
        .score-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: var(--accent-subtle);
            padding: 1rem;
            border-radius: 1rem;
        }
        .stat-val {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        /* Mobile Responsiveness */
        @media (max-width: 600px) {
            body {
                padding: 0.5rem;
            }
            .card {
                padding: 1rem;
            }
            h1 {
                font-size: 1.5rem;
            }
            .question-text {
                font-size: 1.1rem;
            }
            .btn {
                width: 100%;
                justify-content: center;
                padding: 0.8rem; /* Larger touch target */
            }
            .nav-grid {
                flex-wrap: wrap;
                gap: 1rem;
            }
            .nav-grid .btn {
                width: auto; /* Nav buttons don't need full width */
                flex: 1;
            }
            .question-dots {
                order: -1; /* Move dots to top */
                width: 100%;
                margin-bottom: 0.5rem;
            }
            .dot {
                width: 14px; /* Larger dots */
                height: 14px;
            }
            .score-details {
                grid-template-columns: 1fr;
            }
            .score-big {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <h1>Test di Fisica</h1>
        <!--<p class="subtitle">Esercitazione su Prova Alpha 2 (Pag. 8-17)</p>-->
    </header>

    <!-- Start View -->
    <div id="start-view" class="view active">
        <div class="card" style="text-align: center;">
            <span class="material-symbols-rounded" style="font-size: 4rem; color: var(--accent-color); margin: 0 auto;">school</span>
            <h2>Sei pronto?</h2>
            <p>Il test contiene domande a risposta multipla e completamento.</p>
            <p style="font-size: 0.9rem; color: var(--text-secondary);">Puoi navigare liberamente tra le domande.<br>I risultati verranno mostrati solo alla fine.</p>
            
            <button class="btn" onclick="app.startTest()" style="margin-top: 1rem;">
                Inizia Test <span class="material-symbols-rounded">arrow_forward</span>
            </button>
        </div>
        
        <div class="card" style="background: var(--accent-subtle); border-color: var(--accent-light);">
             <h3 style="margin-bottom: 0px;">Info</h3>
             <p style="font-size: 0.85rem;">
                 Le domande sono tratte dall'esame di fisica del semestre filtro di medicina.
             </p>
        </div>
    </div>

    <!-- Quiz View -->
    <div id="quiz-view" class="view">
        <div class="card">
            <div class="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            
            <div class="question-header" style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                <span style="font-weight: 700; color: var(--accent-color);">Domanda <span id="q-current">1</span>/<span id="q-total">10</span></span>
                <span id="review-indicator" style="display:none; color: var(--text-secondary); font-size: 0.8rem;">MODALITÀ REVISIONE</span>
            </div>

            <div id="question-container">
                <div class="question-text" id="question-text">
                    Caricamento domanda...
                </div>
                
                <div id="options-container" style="margin-top: 1.5rem;">
                    <!-- Options injected here -->
                </div>
                
                <div id="feedback-banner" class="feedback-banner"></div>
            </div>

            <div class="nav-grid">
                <button class="btn secondary" id="prev-btn" onclick="app.prevQuestion()">
                    <span class="material-symbols-rounded">arrow_back</span>
                </button>
                
                <div class="question-dots" id="dots-container">
                    <!-- Dots -->
                </div>

                <button class="btn" id="next-btn" onclick="app.nextQuestion()">
                    <span class="material-symbols-rounded">arrow_forward</span>
                </button>
            </div>
            
            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn outline" id="submit-btn" onclick="app.submitTest()">
                    Consegna Test <span class="material-symbols-rounded">check</span>
                </button>
                <button class="btn outline" id="end-review-btn" onclick="app.reset()" style="display: none;">
                    Torna alla Home
                </button>
            </div>
        </div>
    </div>

    <!-- Results View -->
    <div id="results-view" class="view">
        <div class="card results-summary">
            <h2>Risultati</h2>
            
            <div class="score-big" id="final-score">0%</div>
            
            <div class="score-details">
                <div class="stat-card">
                    <div class="stat-val" id="correct-count">0</div>
                    <div class="stat-label">Corrette</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val" id="points-total">0</div>
                    <div class="stat-label">Punti</div>
                </div>
            </div>
            
            <p id="motivational-text">...</p>
            
            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1rem;">
                <button class="btn secondary" onclick="app.startReview()">
                    <span class="material-symbols-rounded">visibility</span> Rivedi Errori
                </button>
                <button class="btn" onclick="app.reset()">
                    <span class="material-symbols-rounded">refresh</span> Riprova
                </button>
            </div>
        </div>
    </div>

</div>

<script>
/**
 * DATA STRUCTURE
 * Replace this array with real data from PDF
 */
const rawQuestions = [
    // Risposta Multipla
    {
        id: 1,
        type: 'multiple',
        text: "In un gas reale:",
        options: [
            "Fra le particelle non esistono interazioni a distanza",
            "Il covolume non è trascurabile",
            "Gli urti tra particelle sono perfettamente elastici",
            "Le particelle sono puntiformi",
            "Vale la relazione PV = nRT"
        ],
        correct: "Il covolume non è trascurabile",
        points: 1
    },
    {
        id: 2,
        type: 'multiple',
        text: "Una zattera di legno a base quadrata di lato 4 m e altezza 50 cm galleggia sull’acqua portando un carico di 400 kg. Sapendo che la densità del legno è 0,8 g/cm³, qual è l’altezza della zattera immersa in acqua?",
        options: ["45 cm", "42,5 cm", "40 cm", "37,5 cm", "35 cm"],
        correct: "42,5 cm",
        points: 1
    },
    {
        id: 3,
        type: 'multiple',
        text: "La grandezza fisica energia cinetica di un corpo:",
        options: [
            "si misura in kg/s²",
            "si misura in watt",
            "si misura in joule",
            "è costante nel moto uniformemente accelerato",
            "è nulla nel moto rettilineo uniforme"
        ],
        correct: "si misura in joule",
        points: 1
    },
    {
        id: 4,
        type: 'multiple',
        text: "Un volume di 10 dm³ corrisponde a:",
        options: ["100 mL", "100 L", "10 L", "1 L", "10 mL"],
        correct: "10 L",
        points: 1
    },
    {
        id: 5,
        type: 'multiple',
        text: "Una nave percorre in successione 10 km verso Nord, 6 km verso Est e infine 18 km verso Sud. Quanto vale il modulo dello spostamento risultante?",
        options: ["15 km", "10 km", "5 km", "25 km", "20 km"],
        correct: "10 km",
        points: 1
    },
    {
        id: 6,
        type: 'multiple',
        text: "Un’onda sonora di frequenza f si propaga con velocità v dentro un lungo tubo di sezione A. Se si raddoppia la frequenza dell’onda sonora, a parità del resto, la potenza mediata su un periodo trasportata dall’onda:",
        options: [
            "Si dimezza",
            "Resta inalterata",
            "Diventa un quarto",
            "Raddoppia",
            "Aumenta di un fattore 4"
        ],
        correct: "Aumenta di un fattore 4",
        points: 1
    },
    {
        id: 7,
        type: 'multiple',
        text: "La variazione di energia interna di un gas perfetto che va da uno stato A a uno stato B vale:",
        options: ["n cV ΔP", "n cV ΔT", "n cP ΔT", "n cV ΔT", "n cP ΔP"],
        correct: "n cV ΔT",
        points: 1
    },
    {
        id: 8,
        type: 'multiple',
        text: "Le linee di campo elettrico all’interno di un condensatore piano ideale sono:",
        options: [
            "Dirette dall’armatura positiva a quella negativa perpendicolarmente ad esse",
            "Cilindriche attorno alle armature",
            "Dirette dall’armatura negativa a quella positiva perpendicolarmente ad esse",
            "Parallele alle superfici delle armature",
            "A raggiera"
        ],
        correct: "Dirette dall’armatura positiva a quella negativa perpendicolarmente ad esse",
        points: 1
    },

    // Completamento
    {
        id: 9,
        type: 'fill',
        text: "Un elettrone si sposta tra due punti di un campo elettrico tra i quali esiste una d.d.p. di 3 × 10⁴ V. La variazione di energia dell’elettrone è pari a ____ keV.",
        correct: "30",
        points: 2
    },
    {
        id: 10,
        type: 'fill',
        text: "Una velocità di 30 m/s espressa in km/h vale ____.",
        correct: "108",
        points: 2
    },
    {
        id: 11,
        type: 'fill',
        text: "Le linee di forza del campo magnetico sono ____.",
        correct: "chiuse",
        points: 2
    },
    {
        id: 12,
        type: 'fill',
        text: "Il grafico spazio–tempo di un moto uniformemente accelerato è di forma ____.",
        correct: "parabolica",
        points: 2
    },
    {
        id: 13,
        type: 'fill',
        text: "La forza elettrica tra due cariche secondo la legge di Coulomb è inversamente proporzionale al quadrato della ____ che le separa.",
        correct: "distanza",
        points: 2
    },
    {
        id: 14,
        type: 'fill',
        text: "Sapendo che 1 m = 100 cm, un’accelerazione di 320 cm/s² corrisponde a ____ m/s².",
        correct: "3,20",
        points: 2
    },
    {
        id: 15,
        type: 'fill',
        text: "Lo scambio di calore può avvenire tramite conduzione, convezione e ____.",
        correct: "irraggiamento",
        points: 2
    }
];

class App {
    constructor() {
        this.questions = [];
        this.currentIndex = 0;
        this.userAnswers = {}; // { qId: answer }
        this.isReviewMode = false;
        this.isSubmitted = false;
        this.shuffledOptionsMap = {}; // Cache shuffled options for consistency during session
        
        // DOM Elements
        this.views = {
            start: document.getElementById('start-view'),
            quiz: document.getElementById('quiz-view'),
            results: document.getElementById('results-view')
        };
    }

    init() {
        // Initialize questions
        this.questions = JSON.parse(JSON.stringify(rawQuestions));
        
        // Load State
        const saved = localStorage.getItem('fisica_test_state');
        if (saved) {
            try {
                const state = JSON.parse(saved);
                this.userAnswers = state.userAnswers || {};
                this.currentIndex = state.currentIndex || 0;
                this.shuffledOptionsMap = state.shuffledOptionsMap || {};
                this.isReviewMode = state.isReviewMode || false;
                this.isSubmitted = state.isSubmitted || false;
                
                // If map missing, regen (shouldn't happen on valid save)
                if (Object.keys(this.shuffledOptionsMap).length === 0) {
                    this.prepareShuffledOptions();
                }

                if (this.isSubmitted) {
                    if (this.isReviewMode) {
                        this.startReview(true);
                    } else {
                        this.showResults(); // Direct show
                    }
                } else if (Object.keys(this.userAnswers).length > 0) {
                     // Resume
                     this.switchView('quiz');
                     this.renderDots();
                     this.loadQuestion(this.currentIndex);
                } else {
                     this.prepareShuffledOptions();
                }
            } catch (e) {
                console.error("Error loading state", e);
                this.prepareShuffledOptions();
            }
        } else {
            this.prepareShuffledOptions();
        }
    }

    saveState() {
        const state = {
            userAnswers: this.userAnswers,
            currentIndex: this.currentIndex,
            shuffledOptionsMap: this.shuffledOptionsMap,
            isReviewMode: this.isReviewMode,
            isSubmitted: this.isSubmitted
        };
        localStorage.setItem('fisica_test_state', JSON.stringify(state));
    }

    prepareShuffledOptions() {
        this.questions.forEach(q => {
            if (q.type === 'multiple') {
                if (this.shuffledOptionsMap[q.id]) return; // Don't overwrite if exists (unless forced?)
                
                let opts = [...q.options];
                for (let i = opts.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [opts[i], opts[j]] = [opts[j], opts[i]];
                }
                this.shuffledOptionsMap[q.id] = opts;
            }
        });
    }

    switchView(viewName) {
        Object.values(this.views).forEach(el => el.classList.remove('active'));
        this.views[viewName].classList.add('active');
    }

    startTest() {
        // Fresh start
        this.isSubmitted = false;
        this.isReviewMode = false;
        this.userAnswers = {};
        this.currentIndex = 0;
        // Re-shuffle for a brand new attempt
        this.shuffledOptionsMap = {}; 
        this.prepareShuffledOptions();
        
        this.saveState();
        
        document.getElementById('submit-btn').style.display = 'inline-flex';
        document.getElementById('end-review-btn').style.display = 'none';
        document.getElementById('review-indicator').style.display = 'none';
        
        document.getElementById('quiz-view').classList.remove('review-mode');
        
        this.renderDots();
        this.loadQuestion(0);
        this.switchView('quiz');
    }

    loadQuestion(index) {
        this.currentIndex = index;
        this.saveState(); // Save current index position
        
        const q = this.questions[index];
        const container = document.getElementById('question-container');
        
        // Update Header
        document.getElementById('q-current').textContent = index + 1;
        document.getElementById('q-total').textContent = this.questions.length;
        document.getElementById('progress-bar').style.width = `${((index + 1) / this.questions.length) * 100}%`;
        
        // Render Text
        let htmlContent = q.text;
        if (q.image) {
            htmlContent += `<div style="margin: 1rem 0; text-align: center;"><img src="${q.image}" style="max-width: 100%; max-height: 300px; border-radius: 0.5rem; border: 2px solid var(--border-color);"></div>`;
        }
        document.getElementById('question-text').innerHTML = htmlContent;
        
        // Render Options/Input
        const optionsContainer = document.getElementById('options-container');
        optionsContainer.innerHTML = '';
        
        // In Review Mode, show feedback banner
        const banner = document.getElementById('feedback-banner');
        banner.style.display = 'none';
        banner.className = 'feedback-banner';

        if (this.isReviewMode) {
            const userAnswer = this.userAnswers[q.id];
            const isCorrect = this.checkAnswer(q, userAnswer);
            banner.style.display = 'block';
            banner.textContent = isCorrect ? "Risposta Corretta" : "Risposta Errata";
            banner.className = 'feedback-banner ' + (isCorrect ? 'correct' : 'wrong');
        }

        if (q.type === 'multiple') {
            const opts = this.shuffledOptionsMap[q.id];
            const list = document.createElement('div');
            list.className = 'options-list';
            
            opts.forEach((opt, idx) => {
                const item = document.createElement('div');
                item.className = 'option-item';
                
                const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
                const letter = letters[idx];
                
                item.innerHTML = `
                    <div class="option-circle">${letter}</div>
                    <div class="option-content">${opt}</div>
                `;
                
                if (this.userAnswers[q.id] === opt) {
                    item.classList.add('selected');
                }
                
                if (!this.isReviewMode) {
                    item.onclick = () => {
                        this.userAnswers[q.id] = opt;
                        this.saveState(); // Save answer
                        this.renderDots();
                        this.loadQuestion(this.currentIndex);
                    };
                } else {
                    if (opt === q.correct) item.classList.add('correct-answer');
                    if (this.userAnswers[q.id] === opt && opt !== q.correct) item.classList.add('user-wrong');
                }
                
                list.appendChild(item);
            });
            optionsContainer.appendChild(list);
            
        } else if (q.type === 'fill') {
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'fill-input';
            input.placeholder = 'Inscerisci la tua risposta...';
            input.value = this.userAnswers[q.id] || '';
            
            if (this.isReviewMode) {
                input.disabled = true;
                const solutionDiv = document.createElement('div');
                solutionDiv.style.marginTop = '1rem';
                solutionDiv.innerHTML = `Risposta corretta: <span class="highlight-yellow"><b>${q.correct}</b></span>`;
                optionsContainer.appendChild(solutionDiv);
                
                if (this.checkAnswer(q, input.value)) {
                    input.style.borderColor = 'var(--correct-color)';
                    input.style.backgroundColor = 'rgba(16, 185, 129, 0.05)';
                } else {
                    input.style.borderColor = 'var(--wrong-color)';
                    input.style.backgroundColor = 'rgba(239, 68, 68, 0.05)';
                }
            } else {
                input.oninput = (e) => {
                    this.userAnswers[q.id] = e.target.value;
                    this.saveState(); // Save answer
                    this.renderDots();
                };
            }
            optionsContainer.appendChild(input);
        }
        
        this.updateNavButtons();
        this.updateDots();
    }

    renderDots() {
        const container = document.getElementById('dots-container');
        container.innerHTML = '';
        this.questions.forEach((q, idx) => {
            const dot = document.createElement('div');
            dot.className = 'dot';
            
            if (idx === this.currentIndex) dot.classList.add('active');
            
            if (this.isReviewMode) {
                const isCorrect = this.checkAnswer(q, this.userAnswers[q.id]);
                dot.classList.add(isCorrect ? 'correct' : 'wrong');
            } else {
                if (this.userAnswers[q.id]) dot.classList.add('answered');
            }
            
            dot.onclick = () => this.loadQuestion(idx);
            container.appendChild(dot);
        });
    }

    updateDots() {
        // Optimization: could strictly update classes, but full re-render is cheap here
        this.renderDots();
    }

    updateNavButtons() {
        document.getElementById('prev-btn').disabled = (this.currentIndex === 0);
        document.getElementById('next-btn').disabled = (this.currentIndex === this.questions.length - 1);
    }

    nextQuestion() {
        if (this.currentIndex < this.questions.length - 1) {
            this.loadQuestion(this.currentIndex + 1);
        }
    }

    prevQuestion() {
        if (this.currentIndex > 0) {
            this.loadQuestion(this.currentIndex - 1);
        }
    }

    checkAnswer(question, userAnswer) {
        if (!userAnswer) return false;
        
        if (question.type === 'multiple') {
            return userAnswer === question.correct;
        } else {
            const u = userAnswer.trim().toLowerCase();
            const c = question.correct.trim().toLowerCase();
            if (u === c) return true;
            const uNum = u.replace(',', '.');
            const cNum = c.replace(',', '.');
            if (!isNaN(uNum) && !isNaN(cNum) && uNum !== '' && cNum !== '') {
                 return Math.abs(parseFloat(uNum) - parseFloat(cNum)) < 0.0001;
            }
            return false;
        }
    }

    submitTest(skipConfirm = false) {
        if (!skipConfirm && !confirm('Sei sicuro di voler consegnare? Non potrai cambiare le risposte.')) return;
        
        this.isSubmitted = true;
        this.saveState();
        this.showResults();
    }

    showResults() {
        let correctCount = 0;
        let pointsEarned = 0;
        let totalPoints = 0;
        
        this.questions.forEach(q => {
            totalPoints += q.points;
            if (this.checkAnswer(q, this.userAnswers[q.id])) {
                correctCount++;
                pointsEarned += q.points;
            }
        });
        
        const percentage = Math.round((pointsEarned / totalPoints) * 100);
        
        document.getElementById('final-score').textContent = `${percentage}%`;
        document.getElementById('correct-count').textContent = `${correctCount}/${this.questions.length}`;
        document.getElementById('points-total').textContent = pointsEarned;
        
        let msg = "";
        if (percentage >= 90) msg = "Eccellente! Sei un genio della fisica!";
        else if (percentage >= 70) msg = "Ottimo lavoro! Continua così.";
        else if (percentage >= 50) msg = "Superato, ma c'è spazio per migliorare.";
        else msg = "Non mollare! Ripassa gli argomenti e riprova.";
        
        document.getElementById('motivational-text').textContent = msg;
        this.switchView('results');
    }

    startReview(skipReset = false) {
        this.isReviewMode = true;
        if (!skipReset) {
            this.currentIndex = 0;
            this.saveState();
        }
        
        document.getElementById('quiz-view').classList.add('review-mode');
        document.getElementById('submit-btn').style.display = 'none';
        document.getElementById('end-review-btn').style.display = 'inline-flex';
        document.getElementById('review-indicator').style.display = 'inline';
        
        this.loadQuestion(this.currentIndex);
        this.switchView('quiz');
    }
    
    reset() {
        if (confirm('Vuoi davvero ricominciare il test? I tuoi progressi verranno persi.')) {
            localStorage.removeItem('fisica_test_state');
            this.switchView('start');
            this.userAnswers = {};
            this.isSubmitted = false;
            this.isReviewMode = false;
        }
    }
}

const app = new App();
app.init();

</script>
</body>
</html>
